---
title: "CHP Data Analysis"
author: "Josh Pepper"
date: "March 9, 2016"
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'index.html')) })
output:
  html_document:
    theme: yeti
    toc: true
    toc_float: true
    number_sections: true
---

```{r global_options, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(fig.width=8, echo=TRUE, warning=FALSE, message=FALSE)
```

#Introduction
This file is intended to describe the analysis of the CHP SWITRS data set and display maps and results of the analysis.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr, verbose = FALSE)
library(ggplot2, verbose = FALSE)
library(leaflet, verbose = FALSE)

switrs_all <- read.csv("Collisions.csv")

#take a subset for only data with lat/long
switrs <- subset(switrs_all, POINT_X!=0 & POINT_Y!=0)

#rename lat and long fields
switrs$lat <- switrs$POINT_Y
switrs$long <- switrs$POINT_X

#add jitter to points
switrs$lat <- jitter(switrs$lat, factor = .8)
switrs$long <- jitter(switrs$long, factor = .8)

#reformat dates
switrs$date <- as.Date(as.character(switrs$DATE_), "%m/%d/%y")
```

#Summary statistics

* Number of rows in the data set: *`r dim(switrs)[1]`*
* Number of columns in the data set: *`r dim(switrs)[2]`*
* Names of columns in the data set:
    + `r names(switrs)`
* More information on each column and its possible values can be found in the <a href="./SWITRS_codebook.pdf" target="_blank">SWITRS Codebook</a>.

##Incidents by Month
```{r, echo=FALSE}

d2 <- switrs %>% group_by(MONTH_) %>% summarise(n=n())
    #d2$month <- factor(d2$MONTH_, levels= c("Jan", "Feb","Mar", "Apr","May","June","July","Aug","Sep","Oct","Nov","Dec"))
    #d2 <- d2[order(d2$DayOfWeek), ]
d2$MONTH_ <- factor(d2$MONTH_)
    
ggplot(d2, aes(x=MONTH_, y=n)) + 
  geom_bar(stat = "identity", alpha=0.6) + 
  theme_minimal() +
  labs(y=NULL, x=NULL, title="Total incidencts by Month") +
  scale_x_discrete(labels=c("Jan", "Feb","Mar", "Apr","May","June","July","Aug","Sep","Oct","Nov","Dec")) +
  scale_y_continuous(expand=c(0,0))

```

##Incidents by day of week
```{r, echo=FALSE}

d2 <- switrs %>% group_by(DAYWEEK) %>% summarise(n=n())
    #d2$month <- factor(d2$MONTH_, levels= c("Jan", "Feb","Mar", "Apr","May","June","July","Aug","Sep","Oct","Nov","Dec"))
    #d2 <- d2[order(d2$DayOfWeek), ]
d2$DAYWEEK <- factor(d2$DAYWEEK)
#d2$DAYWEEK <- factor(d2$DAYWEEK, levels=c(1,2,3,4,5,6,7))
#d2 <- d2[order(d2$DAYWEEK), ]
    
ggplot(d2, aes(x=DAYWEEK, y=n)) + 
  geom_bar(stat = "identity", alpha=0.6) + 
  theme_minimal() +
  labs(y=NULL, x=NULL, title="Total incidencts by Day of Week") +
  scale_x_discrete(labels=c("Su","M","Tu","W","Th","F","Sa")) +
  scale_y_continuous(expand=c(0,0))

```

##Incidents by time of day
```{r, echo=FALSE}

switrs$time <- switrs[,"TIME_"] %>% formatC(digits = 3, flag = "0")
switrs$time <- as.POSIXlt(switrs$time, format="%H%M")$hour

timeValues <-tapply(switrs$CASEID, switrs$time, length)
timeValues <- as.data.frame(timeValues)
    
    #make a column with district name
    timeValues$time <- row.names(timeValues)
    timeValues$time <- as.POSIXlt(timeValues$time, format="%H")$hour
    timeValues[is.na(timeValues),] <- 0
    
    hours <-tapply(timeValues$timeValues, timeValues$time, sum) %>% as.data.frame()
    names(hours) <- "hourCount"
    hours$hour <- row.names(hours)
    
    #sort in descending order
    hours <- transform(hours, hour = reorder(hour, as.numeric(hour)))
    
    #make plot
    ggplot(data = hours, aes( hour, hourCount )) +
      theme_minimal() +
      geom_bar(stat="identity", alpha=0.3) +
      stat_smooth(data=hours, aes(x=hour, y=hourCount, group = 1), colour="blue", n=24, size=2) +
      labs(x=NULL, y=NULL, title="Incidencts by time of day") + 
      expand_limits(y=0) +
      scale_x_discrete(breaks=c(0,6,12,18), labels=c("12:00AM", "6:00AM", "12:00PM","6:00PM"))
```


#First map
Map of all CHP citation in Oakland from 1/1/2013-12/31/2014:

```{r, echo=FALSE}
#map all data from 2013-2014
leaflet() %>% addTiles() %>%
  addCircleMarkers(data=switrs,
                   clusterOptions = markerClusterOptions(spiderfyDistanceMultiplier=2, maxClusterRadius=60),
                   popup=~paste("Date: ", date, "<br/>Time:", TIME_)
  )
```

#Bicyclist data
Notice how one of the columns is titled `BICINJ`. We can map a subset of this data and color code it based on time of accident. I also added a link to more information about each accident using data from the UC Berkeley [Transportation Injury Mapping System (TIPS)](http://tims.berkeley.edu/index.php). TIPS has a [pretty good mapping tool](http://tims.berkeley.edu/tools/gismap/index.php) as well.

```{r, echo=FALSE}
#make bike subset
bike <- subset(switrs, BICINJ==1)

#make color bin
bikeColor <- colorBin(rainbow(25), bike$TIME_, bins=24)


#map all data from 2013-2014
leaflet() %>% addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(data=bike, stroke = FALSE, fillOpacity = 0.5, radius=8,
                   popup=~paste("Date: ", date, "<br/>Time: ", TIME_,"<br><a href='http://tims.berkeley.edu/tools/query/collision_details.php?no=",CASEID,"' target='_blank'>Link to Case Details</a>", sep=""),
                   color = ~bikeColor(TIME_)
  ) %>%
      addLegend(title = "Time of collision", pal = bikeColor,
                values = bike$TIME_, opacity = 1, position="bottomleft", labFormat = labelFormat(
                  prefix = '', suffix = ':00',
                  transform = function(x) x/100
                  )
                )
```

